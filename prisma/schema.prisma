
generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "zod-prisma-types"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountTypes {
    Assets
    Liability
    Equity
    Revenue
    Expense
}

enum Gender {
    Male
    Female
}


enum AccountStatus {
  active
  inactive
}


enum SavingsType {
  sharedCap
  memberSavings
}

enum SavingsTransactionType {
  withdrawal
  deposit
}

enum ItemType {
  product
  services
}

enum InvoiceStatus {
  pending
  paid
  cancelled
}

enum JournalType {
  cashReceipts
  cashDisbursement
  generalJournal
}

// Transactional entries that trigger journal postings
enum ReferenceType {
  MemberRegistration
  SalesPayments
  LoanDisbursements
  LoanRepayments
  ManualJournals
}

model Members {
  memberId         String        @id @default(cuid())
  lastName         String              
  firstName        String
  gender           Gender
  idNumber         Int?
  tin              String?
  dateAccepted     DateTime?
  arb              String?
  bodResNo         String?
  membershipType   String?
  civilStatus      String?
  highestEdAttain  String?
  numOfDependents  Int?
  religion         String?
  annualIncom      Int?
  birthDate        DateTime?
  address          String
  occupation       String?
  contactNo        String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @default(now())

  dividends        Dividends[]    
  invoice          Invoice[]
  Journals         JournalEntries[]

  @@map("members")
  @@index([lastName, firstName])

}

model Invoice {
   invoiceId      BigInt           @id @default(autoincrement())
   memberId       String
   dateOfInvoice  DateTime         @default(now())
   baseGrandTotal Float         
   outStandingAmt Float   
   journalId      BigInt?
   Members        Members          @relation(fields: [memberId], references: [memberId])

   InvoiceItems   InvoiceItems[]  
   InvoicePayments InvoicePayments[]


  @@map("invoices")
  @@index([dateOfInvoice, memberId, outStandingAmt])
}

model InvoiceItems {
  invoiceItemId   BigInt      @id @default(autoincrement())
  invoiceId       BigInt
  itemID          String
  rate            Int
  trade           Int?
  quantity        Int



  Item            Items      @relation(fields: [itemID] , references: [itemID])           
  Invoice         Invoice    @relation(fields: [invoiceId], references: [invoiceId], onDelete: Cascade)



  @@map("invoice_items")
}

model InvoicePayments {
  paymentId       BigInt             @id  @default(autoincrement())
  invoiceId       BigInt
  orNo            String
  paymentReceived Float 
  journalRef      BigInt
  paymentDate     DateTime          @default(now())

  JournalEntry    JournalEntries    @relation(references: [entryId], fields: [journalRef])
  Invoice         Invoice           @relation(references: [invoiceId], fields: [invoiceId])

  @@map("invoice_payments")
  @@index([invoiceId])
}

model Items {
  itemID          String       @id @default(cuid())
  itemName        String
  itemDescription String?
  itemType        ItemType
  sellingPrice    Int
  costPrice       Int?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now())
  stocks          Int?         @default(0)

  InvoiceItems    InvoiceItems[]


}

// second level of account tree
model AccountsSecondLvl {
  rootId          Int           @id @default(autoincrement())
  rootType        AccountTypes
  rootName        String
  createdAt       DateTime      @default(now())
  Children        AccountsThirdLvl[]

  @@map("accounts_second")
}

model AccountsThirdLvl {
  accountId      String               @id @default(cuid())
  accountName    String
  rootId         Int
  openingBalance Float
  runningBalance Float                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  isActive       Boolean              @default(true)


  RootID         AccountsSecondLvl    @relation(references: [rootId], fields: [rootId])

  Dividends      Dividends[]
  JournalItems   JournalItems[]

}


model Dividends {
  dividendId            BigInt                 @id  @default(autoincrement())
  memberId              String
  accountId             String
  datePosted            DateTime               @default(now())
  amount                Float
  members               Members                @relation(fields: [memberId], references: [memberId])
  account               AccountsThirdLvl       @relation(fields: [accountId], references: [accountId])


  @@map("dividends")
  @@index([memberId, accountId, datePosted])
}

model Savings {
  savingsId            String         @id @default(cuid())
  memberID             String         @unique
  savingsType          SavingsType
  currentBalance       Float
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @default(now())

  @@map("member_savings")
}

model SavingsTransact {
  transactionId       BigInt          @id @default(autoincrement())
  savingsId           String
  transactionType     SavingsTransactionType
}

model JournalEntries {
  entryId             BigInt         @id @default(autoincrement())
  entryDate           DateTime      
  referenceName       String         
  referenceType       ReferenceType
  notes               String?
  createdAt           DateTime       @default(now())
  memberId            String?
  journalType         JournalType

  JournalItems        JournalItems[]
  Members             Members?        @relation(fields: [memberId], references: [memberId])
  InvoicePayments     InvoicePayments[]

  @@map("journal_entries")
  @@index([entryDate, memberId])
}

model JournalItems {
  journalItemsId     BigInt             @id @default(autoincrement())
  entryId            BigInt
  accountId          String
  debit              Float
  credit             Float

  
  JournalEntries     JournalEntries     @relation(references: [entryId], fields: [entryId], onDelete: Cascade)
  Accounts           AccountsThirdLvl   @relation(references: [accountId], fields: [accountId])

  @@map("journal_items")
  @@index([accountId, entryId])
}
